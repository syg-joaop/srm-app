export const useAuthPersistence = () => {
  const storageKeys = {
    email: 'srm_saved_email',
    password: 'srm_saved_password',
    sygecomUser: 'srm_saved_sygecom_user',
    sygecomPassword: 'srm_saved_sygecom_password',
  }

  const encode = (str: string) => btoa(str)
  const decode = (str: string) => {
    try {
      return atob(str)
    } catch {
      return ''
    }
  }

  // Helper para salvar/remover condicionalmente
  const setOrRemove = (key: string, value: string | undefined | null, condition: boolean = true) => {
    if (condition && value) {
      localStorage.setItem(key, value)
    } else {
      localStorage.removeItem(key)
    }
  }

  /**
   * Salva ou remove credenciais baseada nas flags 'remember'
   */
  const persistCredentials = (credentials: any) => {
    if (!import.meta.client) return

    // Credenciais principais
    setOrRemove(storageKeys.email, credentials.email, credentials.remember)
    setOrRemove(storageKeys.password, encode(credentials.password), credentials.remember)

    // Credenciais Sygecom
    const saveSygecom = credentials.sygecomRemember && credentials.sygecomUser
    setOrRemove(storageKeys.sygecomUser, credentials.sygecomUser, saveSygecom)
    setOrRemove(
      storageKeys.sygecomPassword, 
      credentials.sygecomPassword ? encode(credentials.sygecomPassword) : null, 
      saveSygecom
    )
  }

  /**
   * Carrega credenciais salvas para preencher o formulÃ¡rio de login
   */
  const loadSavedCredentials = () => {
    if (!import.meta.client) return {}

    const email = localStorage.getItem(storageKeys.email)
    const passwordEncoded = localStorage.getItem(storageKeys.password)
    const sygecomUser = localStorage.getItem(storageKeys.sygecomUser)
    const sygecomPasswordEncoded = localStorage.getItem(storageKeys.sygecomPassword)

    const result: any = {}

    if (email) {
      result.email = email
      result.remember = true
      if (passwordEncoded) result.password = decode(passwordEncoded)
    }

    if (sygecomUser) {
      result.sygecomUser = sygecomUser
      result.sygecomRemember = true
      if (sygecomPasswordEncoded) result.sygecomPassword = decode(sygecomPasswordEncoded)
    }

    return result
  }

  return {
    persistCredentials,
    loadSavedCredentials
  }
}