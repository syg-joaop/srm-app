import { defineStore } from 'pinia'
import type { User, LoginCredentials, LoginResponse } from '../types'

export const useUserStore = defineStore('user', () => {
  const { persistCredentials } = useAuthPersistence()

  // State
  const user = ref<User | null>(null)
  const loading = ref(false)
  const error = ref<string | null>(null)

  // Getters
  const isAuthenticated = computed(() => !!user.value)
  const userEmail = computed(() => user.value?.email || '')
  const userName = computed(() => user.value?.usuario || '')

  // Actions
  const login = async (credentials: LoginCredentials) => {
    loading.value = true
    error.value = null

    try {
      const body = {
        email: credentials.email,
        password: credentials.password,
        origem: 'API',
        homol: false,
        ...(credentials.sygecomUser && { colaborador: credentials.sygecomUser }),
        ...(credentials.sygecomPassword && { password_colaborador: credentials.sygecomPassword })
      }

      const data = await $fetch<LoginResponse>('/api/login', {
        method: 'POST',
        body
      })

      if (data.user && data.user.length > 0) {
        user.value = data.user[0]
        // Apenas salva credenciais para "Lembrar-me" (preenchimento de form), 
        // não gerencia mais a sessão client-side (agora é cookie httpOnly)
        persistCredentials(credentials)
        return { success: true, data }
      }

      error.value = 'Credenciais inválidas'
      return { success: false, error: error.value }
    } catch (e: any) {
      console.error('Login error:', e)
      error.value = e.data?.message || 'Erro ao fazer login'
      return { success: false, error: error.value }
    } finally {
      loading.value = false
    }
  }

  const logout = async () => {
    try {
      await $fetch('/api/auth/logout', { method: 'POST' })
    } catch (e) {
      console.error('Logout error:', e)
    } finally {
      user.value = null
      error.value = null
      await navigateTo('/login')
    }
  }

  const fetchCurrentUser = async () => {
    loading.value = true
    error.value = null

    try {
      const data = await $fetch<{ user: User }>('/api/auth/me')
      user.value = data.user
      return true
    } catch (e: any) {
      // Se falhar, assume não autenticado
      user.value = null
      return false
    } finally {
      loading.value = false
    }
  }

  return {
    // State
    user,
    loading,
    error,

    // Getters
    isAuthenticated,
    userEmail,
    userName,

    // Actions
    login,
    logout,
    fetchCurrentUser
  }
})
